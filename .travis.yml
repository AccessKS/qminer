language: node_js
node_js:
  - "0.12.7"

env:
  global:
    - secure: "SBIgRrq64/CrsBXsuhNihIwHbXXVC1AkL+fwwVq7R4lwLSSZcjtfWuts8iBKk++n6waJhnwJvlTZz23VKxOpiHJWksj/7SRbF1xtuOJztGoN8KfkHkiG8lU0P9Zr9KBGaDjHJLSLo6e2edUkbmZUZWQeG0juxViyJVO2Y+yMZ68="
    - secure: "lOQrPw74mEtBfDYPsTUyNawmsilPWvI2XoiLHeV511Khhw3adQ7aEckOJmKbaHe6LDXgpoRwSpItiitbY+dw1EIVesS3yzM7b4y1Ib1L3HXlNQenIDF6GW5qcab0ZPSNS/BdkfT2snUtk0p3mopE5rxRpMnxo8SXVUBfRz43nCI="
  matrix:
    - CXXFLAGS=-std=c++0x CXX=g++ CC=gcc
    - CXXFLAGS=-std=c++0x CXX=clang++-3.6 CC=clang NPMOPT=--clang=1
before_install:
  - sudo apt-get update -qq
  - sudo apt-get install -qq uuid-dev
  - sudo apt-get install build-essential
  - npm install -g mocha
  - npm install -g mustache

  # clang setup
  - if [ "$CXX" = "clang++-3.6" ]; then sudo apt-add-repository --yes ppa:ubuntu-toolchain-r/test; fi
  - if [ "$CXX" = "clang++-3.6" ]; then sudo sh -c "echo 'deb http://llvm.org/apt/precise/ llvm-toolchain-precise-3.6 main' >> /etc/apt/sources.list"; fi
  - if [ "$CXX" = "clang++-3.6" ]; then wget -O - http://llvm.org/apt/llvm-snapshot.gpg.key|sudo apt-key add -; fi
  - if [ "$CXX" = "clang++-3.6" ]; then sudo apt-get update; fi
  - if [ "$CXX" = "clang++-3.6" ]; then apt-cache search clang; fi
  - if [ "$CXX" = "clang++-3.6" ]; then sudo apt-get install -y clang-3.6; fi
  # get commit message
  - COMMIT_MESSAGE=$(git show -s --format=%B $TRAVIS_COMMIT | tr -d '\n')
  # figure out if we should publish
  - PUBLISH_BINARY=false
  # if we put [publish binary] in the commit message
  - if test "${COMMIT_MESSAGE#*'[publish binary]'}" != "$COMMIT_MESSAGE"; then PUBLISH_BINARY=true; fi;

install:
  - npm install --build-from-source $NPMOPT
script:
  - ./tools/genExampleTests.sh
  - ./test/nodejs/test.sh
  - if [ "$CXX" = "g++" ] ; then echo gpp ok ; fi
  - echo status pub && echo $PUBLISH_BINARY  
  - if [ "$CXX" = "g++" ] && [[ $PUBLISH_BINARY == true ]]; then echo publishing && ./node_modules/.bin/node-pre-gyp package publish; fi
os: linux
notifications:
  email:  
  - blaz.fortuna@ijs.si
  - jan.rupnik@ijs.si
  - viktor@carvic.si
